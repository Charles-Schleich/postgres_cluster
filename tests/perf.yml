---

- hosts: clients[0]
  gather_facts: no
  tasks:

  - name: generate connstrings
    set_fact:
      connstr: "-C 'host={{item}} user=cluster port=15432 dbname=postgres' "
    with_items:
      groups['nodes'] | reverse | batch(nnodes | d(2) | int) | first
    register: connstrs

  - name: make a list
    set_fact:
      connections: "{{ connstrs.results | map(attribute='ansible_facts.connstr') | join }}"

  - name: copy transfers binary
    copy: src=./perf/{{item}} dest=~/{{item}} mode=0755
    with_items:
      - "perf.go"
      - "transfers.go"

- hosts: clients[0]
  gather_facts: no
  tasks:
  - name: fill the databases
    shell: "go run ~/perf.go ~/transfers.go {{connections}} -g -i"
    register: transfers_result
  - debug: "var=transfers_result"

- hosts: clients[0]
  gather_facts: no
  tasks:
  - name: run transfers
    shell: "go run ~/perf.go ~/transfers.go {{connections}} {{runkeys | d('-g -w 400 -r 1 -n 1000 -a 100000')}}"
    register: transfers_result
  - debug: var=transfers_result

