---

- hosts: clients[0]
  gather_facts: no
  tasks:

  - name: generate connstrings
    set_fact:
      connstr: "-C 'host={{item}} user=cluster port=15432 dbname=postgres' "
    with_items:
      groups['nodes'] | reverse | batch(nnodes | d(2) | int) | first
    register: connstrs

  - name: make a list
    set_fact:
      connections: "{{ connstrs.results | map(attribute='ansible_facts.connstr') | join }}"

  - name: copy transfers binary
    copy: src=./{{item}} dest=~/{{item}} mode=0755
    with_items:
      - "dtmbench.cpp"

  - name: compile dtmbench
    shell: "g++ -g -Wall -O2 -o dtmbench dtmbench.cpp -lpqxx -pthread "

- hosts: clients[0]
  gather_facts: no
  tasks:
  - name: run transfers
    shell: "./dtmbench {{connections}} -w {{item}} -r 1 -n 1000 -a 100000 -i "
    register: transfers_result
    with_sequence: start=20 end=400 stride=20

  - debug: msg={{transfers_result.results | map(attribute='stdout_lines') | join }}

