---

- hosts: clients
  gather_facts: no
  tasks:

  - name: generate connstrings
    set_fact:
      connstr: "-C 'host={{item}} user=cluster port=15432 dbname=postgres' "
    with_items:
      groups['nodes'] | reverse | batch(nnodes | d(2) | int) | first
    register: connstrs

  - name: make a list
    set_fact:
      connections: "{{ connstrs.results | map(attribute='ansible_facts.connstr') | join }}"

  # - name: copy transfers binary
  #   copy: src=./{{item}} dest=~/{{item}} mode=0755
  #   with_items:
  #     - "dtmbench"
  #     - "libpqxx-4.0.so"

  - name: copy transfers source
    copy: src=./{{item}} dest=~/{{item}} mode=0755
    with_items:
      - "dtmbench.cpp"

  - name: compile dtmbench
    shell: "g++ -g -Wall -O2 -o dtmbench dtmbench.cpp -lpqxx -pthread"

  - name: run transfers
    shell: "./dtmbench {{connections}} -w {{item}} -r 1 -n 100 -a 100000 -i "
    register: transfers_result
    with_sequence: start=100 end=200 stride=100

  - local_action: shell echo "{{transfers_result.results | map(attribute='stdout') | join('\n')}}" >> x.out

  - debug: msg="{{ transfers_result.results | map(attribute='stdout') | join('\n') }}"
