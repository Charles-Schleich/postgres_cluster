<!-- doc/src/xml/tsearch2.xml -->

<sect1 id="tsearch2" xreflabel="tsearch2">
 <title>tsearch2</title>

 <indexterm zone="tsearch2"><primary>tsearch2</primary></indexterm>

 <para>Модуль <application>tsearch2</application> предоставляет функциональность текстового поиска для обратной совместимости с приложениями, которые использовали <application>tsearch2</application> до того, как текстовый поиск был интегрирован в ядро <productname>PostgreSQL</productname> в версии 8.3.</para>

 <sect2>
  <title>Вопросы переносимости</title>

  <para>Хотя встроенные функции текстового поиска были основаны на функциях <application>tsearch2</application> и во многом похожи, есть ряд небольших различий, из-за которых возникают вопросы переносимости с существующими приложениями:</para>

  <itemizedlist mark="bullet">
   <listitem>
    <para>Были изменены имена некоторых функций, например функция <function>rank</function> стала <function>ts_rank</function>. Модуль замены <literal>tsearch2</literal> предоставляет псевдонимы для старых имён.</para>
   </listitem>

   <listitem>
    <para>Все типы данных и функции встроенного текстового поиска существуют в системной схеме <literal>pg_catalog</literal>. При установке из <application>tsearch2</application> эти объекты обычно помещались в схему <literal>public</literal>, хотя некоторые пользователи могли поместить их в специальную отдельную схему. Таким образом, ссылки на объекты, дополненные схемой, окажутся нерабочими в любом случае. Модуль замены <literal>tsearch2</literal> предоставляет для этих объектов псевдонимы, которые помещаются в схему <literal>public</literal> (или другую, если это требуется), чтобы такие ссылки продолжали работать.</para>
   </listitem>

   <listitem>
    <para>Для встроенных функций текстового поиска отсутствуют понятия <quote>текущий анализатор</quote> и <quote>текущий словарь</quote>, есть только текущая конфигурация поиска (она задаётся параметром <varname>default_text_search_config</varname>). Хотя текущий анализатор и текущий словарь использовались раньше только функциями, предназначенными для отладки, это всё же может мешать переносимости в некоторых случаях. Модуль замены <literal>tsearch2</literal> имитирует эти дополнительные переменные состояния и предоставляет обратно-совместимые функции, позволяющие задать и прочитать их.</para>
   </listitem>
  </itemizedlist>

  <para>Есть ряд проблем, решения которых не предлагает модуль <literal>tsearch2</literal>, так что код приложения придётся корректировать в любом случае:</para>

  <itemizedlist mark="bullet">
   <listitem>
    <para>Старая триггерная функция <function>tsearch2</function> могла принимать в списке аргументов имена функций, вызываемых с текстовыми данными до того, как они были преобразованы в формат <type>tsvector</type>. Эта возможность была ликвидирована как угроза безопасности, так как нельзя гарантировать, что вызываться будет именно запланированная функция. Если данные нужно как-то обработать перед индексацией, рекомендуется написать дополнительный триггер, который будет делать это сам.</para>
   </listitem>

   <listitem>
    <para>Информация о конфигурации текстового поиска была перенесена в системные каталоги, которые значительно отличаются от таблиц аналогичного предназначения в <application>tsearch2</application>. Все приложения, анализирующие или модифицирующие эти таблицы, нуждаются в корректировке.</para>
   </listitem>

   <listitem>
    <para>Ели приложение использует какие-либо нестандартные конфигурации текстового поиска, их нужно будет настроить в системных каталогах, применив новые SQL-команды конфигурирования текстового поиска. Модуль замены <literal>tsearch2</literal> предлагает небольшую помощь в этом, позволяя загружать старый набор конфигурационных таблиц <application>tsearch2</application> в <productname>PostgreSQL</productname> 8.3. (Без этого модуля загрузить данные конфигурации невозможно, так как значения в столбцах <type>regprocedure</type> нельзя сопоставить с функциями.) Эти таблицы конфигурации на самом деле не будут ничего <emphasis>делать</emphasis>, но их содержимое будет полезно хотя бы для того, чтобы получить аналогичную конфигурацию в 8.3.</para>
   </listitem>

   <listitem>
    <para>Старые функции <function>reset_tsearch()</function> и <function>get_covers()</function> не поддерживаются.</para>
   </listitem>

   <listitem>
    <para>Модуль замены <literal>tsearch2</literal> не определяет никакие псевдонимы операторов, полностью рассчитывая на встроенные. Это может вызвать проблемы, если в приложении использовались имена операторов с явным указанием схемы, что встречается очень редко.</para>
   </listitem>
  </itemizedlist>

 </sect2>

 <sect2>
  <title>Преобразование инсталляции версии до 8.3</title>

  <para>Обновлять инсталляцию версии до 8.3, в которой использовалось расширение <application>tsearch2</application>, рекомендуется следующим образом:</para>

  <procedure>
   <step>
    <para>Выгрузите данные старой инсталляции обычным способом, не используя ключ <literal>-c</literal> (<literal>--clean</literal>) программы <application>pg_dump</application> или <application>pg_dumpall</application>.</para>
   </step>

   <step>
    <para>В новой инсталляции создайте пустые базы данных и установите модуль замены <literal>tsearch2</literal> в каждую базу, где будет использоваться текстовый поиск. Это нужно сделать <emphasis>до</emphasis> загрузки данных в базу! Если в старой инсталляции объекты <application>tsearch2</application> содержались в схеме, отличной от <literal>public</literal>, обязательно отразите это в команде <command>CREATE EXTENSION</command>, чтобы заменяющие объекты создавались в той же схеме.</para>
   </step>

   <step>
    <para>Загрузите выгруженные данные. При этом могут возникнуть ошибки из-за невозможности воссоздать первоначальные объекты <application>tsearch2</application>. Хотя их можно игнорировать, это значит, что вы не сможете восстановить выгруженные данные в одной транзакции (то есть, нельзя использовать ключ <option>-1</option> команды <application>pg_restore</application>).</para>
   </step>

   <step>
    <para>Изучите содержимое восстановленных конфигурационных таблиц <application>tsearch2</application> (<structname>pg_ts_cfg</structname> и т. д.) и создайте аналогичные конфигурации текстового поиска по потребности. Получив из старых конфигурационных таблиц всю полезную информацию, вы можете удалить их.</para>
   </step>

   <step>
    <para>Протестируйте работу приложения.</para>
   </step>
  </procedure>

  <para>Позже вы можете поменять ссылки в приложении на псевдонимы объектов текстового поиска, что позволит в конце концов удалить модуль замены <literal>tsearch2</literal>.</para>

 </sect2>

 <sect2>
  <title>Ссылки</title>
  <para>Сайт разработки Tsearch2 <ulink url="http://www.sai.msu.su/~megera/postgres/gist/tsearch/V2/"/></para>
 </sect2>

</sect1>
