<!--
doc/src/xml/ref/analyze.xml
&productname; documentation
-->

<refentry id="sql-analyze">
 <indexterm zone="sql-analyze"><primary>ANALYZE</primary></indexterm>

 <refmeta>
  <refentrytitle>ANALYZE</refentrytitle>
  <manvolnum>7</manvolnum>
  <refmiscinfo>Операторы языка SQL</refmiscinfo>
 </refmeta>

 <refnamediv>
  <refname>ANALYZE</refname>
  <refpurpose>собрать статистику по базе данных</refpurpose>
 </refnamediv>

 <refsynopsisdiv>
<synopsis>ANALYZE [ VERBOSE ] [ <replaceable class="parameter">имя_таблицы</replaceable> [ ( <replaceable class="parameter">имя_столбца</replaceable> [, ...] ) ] ]</synopsis>
 </refsynopsisdiv>

 <refsect1>
  <title>Описание</title>

  <para><command>ANALYZE</command> собирает статистическую информацию о содержимом таблиц в базе данных и сохраняет результаты в системном каталоге <link linkend="catalog-pg-statistic"><structname>pg_statistic</structname></link>. Впоследствии планировщик запросов будет использовать эту статистику для выбора наиболее эффективных планов выполнения запросов.</para>

  <para>Без параметров команда <command>ANALYZE</command> анализирует все таблицы в текущей базе данных. Если в параметрах передано имя таблицы, <command>ANALYZE</command> обрабатывает только заданную таблицу. Также эта команда принимает список имён столбцов, что позволяет запустить сбор статистики только по этим столбцам.</para>
 </refsect1>

 <refsect1>
  <title>Параметры</title>

  <variablelist>
   <varlistentry>
    <term><literal>VERBOSE</literal></term>
    <listitem>
     <para>Включает вывод сообщений о процессе выполнения.</para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><replaceable class="parameter">имя_таблицы</replaceable></term>
    <listitem>
     <para>Имя (возможно, дополненное схемой) конкретной таблицы, подлежащей анализу. Если опущено, анализироваться будут все обычные (не сторонние) таблицы в текущей базе данных.</para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><replaceable class="parameter">имя_столбца</replaceable></term>
    <listitem>
     <para>Имя столбца, подлежащего анализу. По умолчанию анализируются все столбцы.</para>
    </listitem>
   </varlistentry>
  </variablelist>
 </refsect1>

 <refsect1>
  <title>Выводимая информация</title>

   <para>С указанием <literal>VERBOSE</literal> команда <command>ANALYZE</command> выдаёт сообщения о процессе анализа, отмечая текущую обрабатываемую таблицу. Также она выводит различные статистические сведения о таблицах.</para>
 </refsect1>

 <refsect1>
  <title>Замечания</title>

  <para>Сторонние таблицы анализируются только при явном указании и только если соответствующая обёртка сторонних данных поддерживает команду <command>ANALYZE</command>. Если эта команда не поддерживается, при выполнении <command>ANALYZE</command> выводится предупреждение и больше ничего не происходит.</para>

  <para>В стандартной конфигурации <productname>&productname;</productname> работающий демон автоочистки (см. <xref remap="4" linkend="autovacuum"/>) запускает анализ таблиц автоматически, когда они изначально заполняются данными, и периодически, по мере того, как они меняются. Если автоочистка отключена, рекомендуется запускать <command>ANALYZE</command> время от времени, либо после кардинальных изменений в таблице. Точная статистика помогает планировщику выбрать наиболее эффективный план запроса и тем самым увеличивает скорость выполнения запроса. Обычно для баз, где данные в основном читаются, выполняют <xref linkend="sql-vacuum"/> и <command>ANALYZE</command> раз в день, во время наименьшей активности. (Этого будет недостаточно, если данные меняются очень активно.)</para>

  <para><command>ANALYZE</command> запрашивает для целевой таблицы блокировку только на чтение, так что эта команда может выполняться параллельно с другими операциями с таблицей.</para>

  <para>Статистика, собираемая командой <command>ANALYZE</command>, обычно включает список из нескольких самых частых значений в каждом столбце и гистограмму, отражающую примерное распределение данных во всех столбцах. Один или оба этих элемента статистики могут быть опущены, если <command>ANALYZE</command> сочтёт их неинтересными (например, в столбце уникального ключа нет повторяющихся значений), либо если тип данных столбца не поддерживает соответствующие операторы. Более подробно статистика описывается в <xref remap="6" linkend="maintenance"/>.</para>

  <para>В больших таблицах <command>ANALYZE</command> не просматривает все строки, а обрабатывает только небольшую случайную выборку. Это позволяет проанализировать за короткое время даже очень большие таблицы. Однако учтите, что такая статистика будет лишь приблизительной и может немного меняться при каждом выполнении <command>ANALYZE</command>, даже если фактическое содержимое таблицы остаётся неизменным. Это может приводить к небольшим изменениям в оценках стоимости запросов, выводимых командой <xref linkend="sql-explain"/>. В редких случаях вследствие этой недетерменированности планировщик меняет свой выбор после выполнения <command>ANALYZE</command>. Чтобы избежать этого, увеличьте объём статистики, собираемой командой <command>ANALYZE</command>, как описано ниже.</para>

  <para>Количеством статистики можно управлять, настраивая конфигурационную переменную <xref linkend="guc-default-statistics-target"/> или устанавливая ориентир статистики на уровне столбцов командой <command>ALTER TABLE ... ALTER COLUMN ... SET STATISTICS</command> (см. <xref remap="4" linkend="sql-altertable"/>). Ориентир задаёт максимальное число записей в списке наиболее распространённых значений и максимальное число интервалов в гистограмме. По умолчанию значение ориентира равно 100, но его можно увеличить или уменьшить в поисках баланса между точностью оценок планировщика и временем, требующимся для выполнения <command>ANALYZE</command>, а также объёмом статистики в таблице <literal>pg_statistic</literal>. Если установить ориентир статистики равным нулю, статистика по таким столбцам собираться не будет. Это может быть полезно для столбцов, которые никогда не фигурируют в предложениях <literal>WHERE</literal>, <literal>GROUP BY</literal> и <literal>ORDER BY</literal>, так как планировщик никогда не будет использовать их статистику.</para>

  <para>Число строк таблицы, выбираемых для подготовки статистики, определяется наибольшим ориентиром статистики по всем анализируемым столбцам этой таблицы. Увеличение ориентира приводит к пропорциональному увеличению времени и пространства, требуемого для выполнения <command>ANALYZE</command>.</para>

  <para>Одним из показателей, оцениваемых командой <command>ANALYZE</command>, является число различных значений, встречающихся в каждом столбце. Так как рассматривается только подмножество всех строк, эта оценка иногда может быть весьма неточной, даже при самых больших ориентирах статистики. Если эта неточность приводит к плохому выбору плана запроса, более точное значение можно определить вручную и затем задать его командой <command>ALTER TABLE ... ALTER COLUMN ... SET (n_distinct = ...)</command> (см. <xref remap="4" linkend="sql-altertable"/>).</para>

  <para>Если у анализируемой таблицы есть один или несколько потомков, <command>ANALYZE</command> соберёт статистику дважды: сначала по строкам только родительской таблицы, а затем по строкам родительской и всех дочерних таблиц. Второй набор статистики необходим для планирования запросов, обращающихся ко всему дереву наследования. Демон автоочистки, однако, принимая решение об автоматическом запуске анализа, будет учитывать операции добавления или изменения данных только в самой родительской таблице. Если именно в этой таблице изменение и добавление происходит редко, наследуемая статистика может терять актуальность, если не запускать <command>ANALYZE</command> вручную.</para>

  <para>Если какие-либо из дочерних таблиц являются сторонними таблицами и их обёртки сторонних данных не поддерживают <command>ANALYZE</command>, эти дочерние таблицы игнорируются при сборе статистики наследования.</para>

  <para>Если анализируемая таблица оказалась пустой, <command>ANALYZE</command> не будет обновлять статистику по этой таблице; в базе сохранится статистика, собранная ранее.</para>
 </refsect1>

 <refsect1>
  <title>Совместимость</title>

  <para>Оператор <command>ANALYZE</command> отсутствует в стандарте SQL.</para>
 </refsect1>

 <refsect1>
  <title>См. также</title>

  <simplelist type="inline">
   <member><xref linkend="sql-vacuum"/></member>
   <member><xref linkend="app-vacuumdb"/></member>
   <member><xref linkend="runtime-config-resource-vacuum-cost"/></member>
   <member><xref linkend="autovacuum"/></member>
  </simplelist>
 </refsect1>
</refentry>
