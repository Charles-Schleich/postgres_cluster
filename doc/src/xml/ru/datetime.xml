<!-- doc/src/xml/datetime.xml -->

 <appendix id="datetime-appendix">
  <title>Поддержка даты и времени</title>

  <para><productname>&productname;</productname> использует внутренний эвристический анализатор для поддержки всех значений даты и времени. Дата и время вводятся как строки и разделяются на различные поля, при этом предварительно определяется, какого рода информация содержится в конкретном поле. Каждое поле интерпретируется и получает числовое значение, игнорируется или отклоняется. Анализатор содержит внутренние справочные таблицы для текстовых полей, включая месяцы, дни недели и часовые пояса.</para>

  <para>Данное приложение включает информацию о содержании справочных таблиц и описывает этапы, необходимые анализатору для распознавания даты и времени.</para>

  <sect1 id="datetime-input-rules">
   <title>Интерпретация данных даты и времени</title>

   <para>Все значения даты и времени расшифровываются при помощи следующей процедуры.</para>

   <procedure>
    <step>
     <para>Разделить входную строку на фрагменты и определить каждый фрагмент как строку, время, часовой пояс или цифру.</para>

     <substeps>
      <step>
       <para>Если числовой фрагмент содержит двоеточие (<literal>:</literal>), значит эта строка представляет время. Включаются все последующие цифры и двоеточия.</para>
      </step>

      <step>
       <para>Если числовой фрагмент содержит тире (<literal>-</literal>), косую черту (<literal>/</literal>) или две и более точек (<literal>.</literal>), то это строка даты, которая, возможно, включает название месяца. Если фрагмент даты уже встречался, он интерпретируется как название часового пояса (например, <literal>America/New_York</literal>).</para>
      </step>

      <step>
       <para>Если этот фрагмент является лишь числом, он представляет собой отдельное поле или составную дату ISO 8601 (например, <literal>19990113</literal> для 13 января 1999 года) или время (например, <literal>141516</literal> для 14:15:16).</para>
      </step>

      <step>
       <para>Если фрагмент начинается с плюса (<literal>+</literal>) или минуса (<literal>-</literal>), то это или числовой часовой пояс или специальное поле.</para>
      </step>
     </substeps>
    </step>

    <step>
     <para>Если фрагмент является текстовой строкой, сопоставить его с возможными строками:</para>

     <substeps>
      <step>
       <para>Выполнить двоичный поиск в справочной таблице соответствующего фрагмента в виде аббревиатуры часового пояса.</para>
      </step>

      <step>
       <para>Если фрагмент не найден, выполнить подобный просмотр в таблице двоичного поиска, чтобы определить фрагмент как специальную строку (например, <literal>today</literal>), день (например, <literal>Thursday</literal>), месяц (например, <literal>January</literal>) или неучитываемое слово (например, <literal>at</literal>, <literal>on</literal>).</para>
      </step>

      <step>
       <para>Если фрагмент всё же не найден, выдать ошибку.</para>
      </step>
     </substeps>
    </step>

    <step>
     <para>Когда фрагмент является числом или числовым полем:</para>

     <substeps>
      <step>
       <para>Если получено восемь или шесть цифр и никакое другое поле даты ранее не было прочитано, интерпретировать их как <quote>составленную дату</quote> (например, <literal>19990118</literal> или <literal>990118</literal>). Такая дата интерпретируется как <literal>ГГГГММДД</literal> или <literal>ГГММДД</literal>.</para>
      </step>

      <step>
       <para>Если фрагмент представляет собой трёхзначное число, и год уже был прочитан, интерпретировать как день года.</para>
      </step>

      <step>
       <para>Если это четыре или шесть цифр и год уже был прочитан, интерпретировать как время (<literal>ЧЧММ</literal> или <literal>ЧЧММСС</literal>).</para>
      </step>

      <step>
       <para>Если найдены три или более цифр, а поля даты ещё не были найдены, интерпретировать как год (это ведёт к установке порядка гг-мм-дд для оставшихся полей даты).</para>
      </step>

      <step>
       <para>В противном случае подразумевается, что порядок сортировки полей даты определяется значением <varname>DateStyle</varname>: мм-дд-гг, дд-мм-гг или гг-мм-дд. Выдать ошибку, если оказалось, что поле месяца или дня вышло за пределы диапазона.</para>
      </step>
     </substeps>
    </step>

    <step>
     <para>Если указан год до н. э., отнять год и добавить единицу для внутреннего хранения. (В григорианском календаре отсутствует нулевой год, поэтому 1 год до н. э. становится нулевым.)</para>
    </step>

    <step>
     <para>Если год до н. э. не был указан, и если поле года имело два разряда, установить для записи года четыре разряда. Если поле меньше 70, добавить 2000, в противном случае добавить 1900. <tip>
       <para>Годы с 1 по 99 н. э. по григорианскому календарю могут вводится при помощи четырёхзначного числа с начальными нулями (например, <literal>0099</literal> это год 99 н. э.).</para>
      </tip></para>
    </step>
   </procedure>
  </sect1>


  <sect1 id="datetime-keywords">
   <title>Ключевые слова для обозначения даты и времени</title>

   <para><xref linkend="datetime-month-table"/> показывает фрагменты, которые распознаются как названия месяцев.</para>

    <table id="datetime-month-table">
     <title>Названия месяцев</title>
     <tgroup cols="2">
      <thead>
       <row>
        <entry>Месяц</entry>
        <entry>Аббревиатуры</entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry>January</entry>
        <entry>Jan</entry>
       </row>
       <row>
        <entry>February</entry>
        <entry>Feb</entry>
       </row>
       <row>
        <entry>March</entry>
        <entry>Mar</entry>
       </row>
       <row>
        <entry>April</entry>
        <entry>Apr</entry>
       </row>
       <row>
        <entry>May</entry>
        <entry/>
       </row>
       <row>
        <entry>June</entry>
        <entry>Jun</entry>
       </row>
       <row>
        <entry>July</entry>
        <entry>Jul</entry>
       </row>
       <row>
        <entry>August</entry>
        <entry>Aug</entry>
       </row>
       <row>
        <entry>September</entry>
        <entry>Sep, Sept</entry>
       </row>
       <row>
        <entry>October</entry>
        <entry>Oct</entry>
       </row>
       <row>
        <entry>November</entry>
        <entry>Nov</entry>
       </row>
       <row>
        <entry>December</entry>
        <entry>Dec</entry>
       </row>
      </tbody>
     </tgroup>
    </table>

    <para><xref linkend="datetime-dow-table"/> показывает фрагменты, которые распознаются как названия дней недели.</para>

     <table id="datetime-dow-table">
      <title>Названия дней недели</title>
      <tgroup cols="2">
       <thead>
        <row>
         <entry>День</entry>
         <entry>Аббревиатуры</entry>
        </row>
       </thead>
       <tbody>
        <row>
         <entry>Sunday</entry>
         <entry>Sun</entry>
        </row>
        <row>
         <entry>Monday</entry>
         <entry>Mon</entry>
        </row>
        <row>
         <entry>Tuesday</entry>
         <entry>Tue, Tues</entry>
        </row>
        <row>
         <entry>Wednesday</entry>
         <entry>Wed, Weds</entry>
        </row>
        <row>
         <entry>Thursday</entry>
         <entry>Thu, Thur, Thurs</entry>
        </row>
        <row>
         <entry>Friday</entry>
         <entry>Fri</entry>
        </row>
        <row>
         <entry>Saturday</entry>
         <entry>Sat</entry>
        </row>
       </tbody>
      </tgroup>
     </table>

   <para><xref linkend="datetime-mod-table"/> показывает фрагменты, которые выполняют различные функции модификаторов.</para>

    <table id="datetime-mod-table">
     <title>Модификаторы поля даты/времени</title>
     <tgroup cols="2">
      <thead>
       <row>
        <entry>Идентификатор</entry>
        <entry>Описание</entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry><literal>AM</literal></entry>
        <entry>Время до 12:00</entry>
       </row>
       <row>
        <entry><literal>AT</literal></entry>
        <entry>игнорируется</entry>
       </row>
       <row>
        <entry><literal>JULIAN</literal>, <literal>JD</literal>, <literal>J</literal></entry>
        <entry>Следующее поле является юлианской датой</entry>
       </row>
       <row>
        <entry><literal>ON</literal></entry>
        <entry>игнорируется</entry>
       </row>
       <row>
        <entry><literal>PM</literal></entry>
        <entry>Время 12:00 и более позднее</entry>
       </row>
       <row>
        <entry><literal>T</literal></entry>
        <entry>Следующее поле указывает на время</entry>
       </row>
      </tbody>
     </tgroup>
    </table>
  </sect1>

  <sect1 id="datetime-config-files">
  <title>Файлы конфигурации даты/времени</title>

   <indexterm><primary>часовой пояс</primary> <secondary>ввод аббревиатур</secondary></indexterm>

   <para>Поскольку аббревиатуры часовых поясов недостаточно стандартизированы, <productname>&productname;</productname> предлагает средства для определения набора аббревиатур, принимаемых сервером. Параметром выполнения <xref linkend="guc-timezone-abbreviations"/> определяется активный набор аббревиатур. Хотя данный параметр может быть изменён любым пользователем базы данных, возможные значения для него контролируются администратором базы данных и являются именами конфигурационных файлов, хранящихся в <filename>.../share/timezonesets/</filename> каталога установки. Добавляя или изменяя файлы в этом каталоге, администратор может определить местную специфику выбора аббревиатур часовых поясов.</para>

   <para>Значение <varname>timezone_abbreviations</varname> может быть установлено в любое имя файла, находящегося в <filename>.../share/timezonesets/</filename>, если имя файла состоит только из букв. (Запрет на использование небуквенных символов в <varname>timezone_abbreviations</varname> делает невозможным чтение файлов, находящихся вне заданного каталога, а также резервных файлов редактора и прочих внешних файлов.)</para>

   <para>Файл аббревиатур часовых поясов может содержать пустые строки и комментарии, начинающиеся с <literal>#</literal>. Строки, не имеющие комментариев, должны иметь один из следующих форматов: <synopsis>
<replaceable>аббревиатура_пояса</replaceable> <replaceable>смещение</replaceable>
<replaceable>аббревиатура_пояса</replaceable> <replaceable>смещение</replaceable> D
<replaceable>аббревиатура_пояса</replaceable> <replaceable>имя_часового_пояса</replaceable>
@INCLUDE <replaceable>имя_файла</replaceable>
@OVERRIDE
</synopsis></para>

   <para>Поле <replaceable>аббревиатура_пояса</replaceable> лишь задаёт определяемую аббревиатуру. <replaceable>Смещение</replaceable> — это целое число, задающее эквивалентное смещение от UTC в секундах, положительное — к востоку от Гринвичского меридиана, а отрицательное — к западу. Например, -18000 означало бы пять часов к западу от Гринвича, или Североамериканское восточное время. <literal>D</literal> указывает, что название пояса представляет местное летнее, а не поясное время.</para>

   <para>В качестве альтернативы может быть задано <replaceable>имя_часового_пояса</replaceable>, определённое в базе данных часовых поясов IANA. В этом случае система обращается к определению пояса, чтобы выяснить, используется или использовалась ли аббревиатура для этого пояса, и если да, действовать будет соответствующее значение &mdash; то есть, значение, действовавшее в указанный момент времени, или действовавшее непосредственно перед ним, если текущее на тот момент неизвестно, либо самое старое значение, если первое определение появилось после этого момента. Это поведение важно для тех аббревиатур, значение которых менялось в ходе истории. Также допускается определение аббревиатуры через имя часового пояса, с которым эта аббревиатура не связана; в таком случае использование аббревиатуры равнозначно написанию просто имени пояса.</para>

   <tip>
    <para>Простое целочисленное <replaceable>смещение</replaceable> предпочтительнее использовать, когда определяется аббревиатура, смещение которой от UTC никогда не менялось, так как обрабатывать подобные аббревиатуры гораздо легче, чем те, что требуют обращения к определению часового пояса.</para>
   </tip>

   <para>Использование <literal>@INCLUDE</literal> позволяет включить другой файл в каталоге <filename>.../share/timezonesets/</filename>. Включение может быть вложенным до ограниченной глубины.</para>

   <para>Использование <literal>@OVERRIDE</literal> указывает, что последующие записи в файле могут переопределять предыдущие (как правило, это записи, полученные из включённых файлов). Без этого указания конфликтующие определения аббревиатуры одного и того же часового пояса считаются ошибкой.</para>

   <para>При установке без внесения изменений, файл <filename>Default</filename> содержит все неконфликтующие аббревиатуры часовых поясов для большей части земного шара. Дополнительные файлы <filename>Australia</filename> и <filename>India</filename> предоставляются для данных регионов. Эти файлы сначала включают файл <literal>Default</literal>, а затем добавляют и изменяют аббревиатуры по мере необходимости.</para>

   <para>В качестве справочной информации стандартная установка также содержит файлы <filename>Africa.txt</filename>, <filename>America.txt</filename> и т. д., содержащие информацию о каждой используемой аббревиатуре часового пояса, включённой в базу данных часовых поясов IANA. Определения названий часовых поясов, находящиеся в этих файлах, можно копировать и помещать в файл с нестандартной конфигурацией по мере необходимости. Заметьте, что данные файлы нельзя указывать непосредственно в значении <varname>timezone_abbreviations</varname>, так как их имена включают точку.</para>

   <note>
    <para>Если при чтении набора аббревиатур часовых поясов возникает ошибка, новое значение не применяется и сохраняется старый набор. Если ошибка возникает при запуске базы данных, происходит сбой.</para>
   </note>

   <caution>
    <para>Аббревиатуры часового пояса, определённые в файле конфигурации, переопределяют не относящиеся к часовому поясу значения, встроенные в <productname>&productname;</productname>. Например, файл конфигурации <filename>Australia</filename> определяет <literal>SAT</literal> (для Южноавстралийского стандартного времени, South Australian Standard Time). Когда этот файл активен, <literal>SAT</literal> не будет распознаваться как сокращение слова "суббота".</para>
   </caution>

   <caution>
    <para>Если вы модифицируете файлы в <filename>.../share/timezonesets/</filename>, вы можете сами выполнить резервное копирование, так как обычный дамп базы данных не содержит этот каталог.</para>
   </caution>

  </sect1>

  <sect1 id="datetime-units-history">
  <title>История единиц измерения времени</title>

  <indexterm zone="datetime-units-history"><primary>Григорианский календарь </primary></indexterm>
  <indexterm zone="datetime-units-history"><primary>Юлианская дата</primary></indexterm>

  <para>Стандарт SQL устанавливает, что <quote>В определении <quote>литерала типа дата-время</quote>, <quote>значения типа дата-время</quote> ограничены естественными правилами, касающимися дат и времени согласно григорианскому календарю</quote>. Следуя стандарту SQL, <productname>&productname;</productname> подсчитывает даты исключительно в григорианском календаре, включая годы, когда этот календарь ещё не использовался. Это правило известно как <firstterm>пролептический григорианский календарь</firstterm>.</para>

  <para>Юлианский календарь был введён Юлием Цезарем в 45 г. до н. э. Он широко использовался западной цивилизацией до 1582 года, когда страны начали переходить на григорианский календарь. В юлианском календаре тропический год длится приблизительно 365 1/4 дня = 365,25 дня. Каждые 128 лет накапливается примерно 1 день.</para>

  <para>Накапливающаяся погрешность побудила папу Григория XIII реформировать календарь в соответствии с постановлениями Тридентского собора. В григорианском календаре тропический год длится приблизительно 365 + 97 / 400 дней = 365,2425 дней. Таком образом, погрешность в один день тропического года накапливается примерно за 3300 лет.</para>

  <para>Приблизительное число 365+97/400 получается из-за того, что из каждых 400 лет 97 високосные. При этом действуют следующие правила: <simplelist>
    <member>Каждый год кратный 4 является високосным.</member>
    <member>Однако каждый год кратный 100 не является високосным.</member>
    <member>Тем не менее, каждый год кратный 400 всё же является високосным.</member>
   </simplelist> Таким образом, 1700, 1800, 1900, 2100 и 2200 не являются високосными годами. Но 1600, 2000 и 2400 — високосные. А в юлианском календаре високосными считаются все годы, кратные 4.</para>

  <para>Папская булла, изданная в феврале 1582 года, предписывала сделать октябрь 1582 года на 10 дней короче, чтобы 15 октября следовало сразу за 4 октября. Это правило соблюдалось в Италии, Польше, Португалии и Испании. Вскоре к ним присоединились и прочие католические страны, но протестантские страны вводили эти изменения неохотно, а страны греческой православной церкви не переходили на новый календарь до начала 20 века. В 1752 г. реформа была проведена в Великобритании и её доминионах (включая территорию сегодняшних Соединённых Штатов Америки). Таким образом, за 2 сентября 1752 года следовало 14 сентября 1752 года. Поэтому в системах Unix программа <command>cal</command> выводит следующее: <screen>
$ <userinput>cal 9 1752</userinput>
   September 1752
 S  M Tu  W Th  F  S
       1  2 14 15 16
17 18 19 20 21 22 23
24 25 26 27 28 29 30
</screen> Но этот календарь действует только в Великобритании и доминионах. В других местах он является недействительным. Чтобы избежать сложностей и возможной путаницы при отслеживании календарей, которыми фактически пользовались в различных местах в разное время, <productname>&productname;</productname> применяет правила григорианского календаря ко всем датам, даже если это нарушает историческую достоверность.</para>

  <para>Разные календари были составлены в различных частях земного шара, многие из них до григорианской системы. Например, появление китайского календаря относится к 14 веку до н. э. Легенда гласит, что император Хуан-ди изобрёл этот календарь в 2637 г. до н. э. В Китайской Народной Республике григорианский календарь используется для официальных и коммерческих нужд. Китайский календарь используется для определения дат традиционных праздников.</para>

  <para><firstterm>Юлианский период</firstterm> является ещё одним типом календаря. Он не имеет отношения к юлианскому календарю, несмотря на схожие названия. Данный способ измерения времени был изобретён французским учёным Жозефом Жюстом Скалигером (1540-1609) и так назван, вероятно, в честь отца Скалигера, итальянского учёного Юлия Цезаря Скалигера (1484-1558). В юлианском периоде, каждый день имеет порядковый номер, начиная с 0 (иногда его называют <emphasis>юлианская дата</emphasis> или JD 0). Первый день имеет номер 0 и соответствует 1 января 4713 г. до н. э. по юлианскому календарю или 24 ноября 4714 г. до н. э. по григорианскому календарю. Юлианская дата чаще всего используется в астрономических расчётах для записи ночных наблюдений, и поэтому день длится от полудня до полудня UTC, а не с полуночи до полуночи: Первый юлианский день (JD 0) обозначает 24 часа от полудня UTC 24 ноября 4714 г. до н. э. до полудня UTC 25 ноября 4714 г. до н. э.</para>

  <para>Хотя <productname>&productname;</productname> поддерживает юлианскую дату для записи входных и выходных дат (а также, использует юлианские даты для некоторых внутренних вычислений в формате дата-время), полдень не считается началом суток. <productname>&productname;</productname> рассматривает юлианский день как длящийся от полуночи до полуночи.</para>

 </sect1>
</appendix>
