<!-- doc/src/xml/diskusage.xml -->

<chapter id="diskusage">
 <title>Мониторинг использования диска</title>

 <para>В данной главе обсуждается как отслеживать использование дискового пространства в СУБД <productname>&productname;</productname>.</para>

 <sect1 id="disk-usage">
  <title>Определение использования диска</title>

  <indexterm zone="disk-usage"><primary>использование диска</primary></indexterm>

  <para>Для каждой таблицы создаётся первичный дисковый файл кучи (heap), в котором хранится большая часть данных. Если в таблице есть столбцы с потенциально большими значениями, то также может быть и ассоциированный с этой таблицей файл <acronym>TOAST</acronym>, который используется для хранения слишком больших значений, не умещающихся в главной таблице (см. <xref remap="4" linkend="storage-toast"/>). На каждую таблицу <acronym>TOAST</acronym>, если она существует, будет существовать один индекс. Также там могут быть и индексы, ассоциированные с базовой таблицей. Каждая таблица и индекс хранятся в отдельном дисковом файле &mdash; возможно более чем в одном файле, если размер этого файла превышает один гигабайт. Преобразования имён для этих файлов описываются в <xref remap="6" linkend="storage-file-layout"/>.</para>

  <para>Вы можете осуществлять мониторинг дискового пространства тремя способами: используя SQL-функции, перечисленные в <xref remap="6" linkend="functions-admin-dbsize"/>, используя модуль <xref linkend="oid2name"/> или просматривая системные каталоги вручную. Вышеупомянутые SQL функции являются наиболее простыми и рекомендуются для использования. В продолжении этого раздела рассказывается, как просматривать системные каталоги.</para>

  <para>Используя <application>psql</application> после недавнего применения команд VACUUM или ANALYZE, вы можете выполнить такой запрос, чтобы увидеть сколько дискового пространства использует какая-либо таблица: <programlisting>SELECT pg_relation_filepath(oid), relpages FROM pg_class WHERE relname = 'customer';

 pg_relation_filepath | relpages
----------------------+----------
 base/16384/16806     |       60
(1 row)</programlisting> Каждая страница обычно равна 8kb. (Помните, что <structfield>relpages</structfield> обновляется только командами <command>VACUUM</command>, <command>ANALYZE</command>, и несколькими командами DDL, такими как <command>CREATE INDEX</command>). Путь к файлу представляет интерес, если вы хотите проанализировать непосредственно файл на диске.</para>

  <para>Чтобы посмотреть пространство, используемое таблицами <acronym>TOAST</acronym>, используйте следующий запрос: <programlisting>SELECT relname, relpages
FROM pg_class,
     (SELECT reltoastrelid
      FROM pg_class
      WHERE relname = 'customer') AS ss
WHERE oid = ss.reltoastrelid OR
      oid = (SELECT indexrelid
             FROM pg_index
             WHERE indrelid = ss.reltoastrelid)
ORDER BY relname;

       relname        | relpages
----------------------+----------
 pg_toast_16806       |        0
 pg_toast_16806_index |        1</programlisting></para>

  <para>Вы можете легко посмотреть размеры индексов: <programlisting>SELECT c2.relname, c2.relpages
FROM pg_class c, pg_class c2, pg_index i
WHERE c.relname = 'customer' AND
      c.oid = i.indrelid AND
      c2.oid = i.indexrelid
ORDER BY c2.relname;

       relname        | relpages
----------------------+----------
 customer_id_indexdex |       26</programlisting></para>

  <para>Также легко найти самые большие таблицы и индексы, используя эту информацию: <programlisting>SELECT relname, relpages
FROM pg_class
ORDER BY relpages DESC;

       relname        | relpages
----------------------+----------
 bigtable             |     3290
 customer             |     3144</programlisting></para>
 </sect1>

 <sect1 id="disk-full">
  <title>Ошибка переполнения диска</title>

  <para>Наиболее важной задачей мониторинга диска для администратора баз данных состоит в том, чтобы иметь уверенность в наличии свободного места на диске. Если диск полон, это не приведёт к повреждению данных, но может не давать выполняться некоторым полезным действиям. Если переполнится диск, который содержит файлы WAL, то сервер СУБД может аварийно завершить свою работу.</para>

  <para>Если вы не можете освободить дополнительное пространство на диске, удалив какие-либо другие файлы, то можно перенести часть файлов базы данных на другие файловые системы, с помощью создания табличных пространств. Подробности об этом смотрите в <xref linkend="manage-ag-tablespaces"/>.</para>

  <tip>
   <para>Некоторые файловые системы плохо работают, когда они почти или совсем заполнены, так что не ждите пока диск заполнится полностью, чтобы выполнить необходимые действия.</para>
  </tip>

  <para>Если ваша система поддерживает дисковые квоты для пользователей, вы должны позаботиться о квоте, выделенной для пользователя, от имени которого запускается сервер СУБД. Если эта квота будет исчерпана, последствия будут столь же негативными, как если просто закончится свободное место на диске.</para>
 </sect1>
</chapter>
