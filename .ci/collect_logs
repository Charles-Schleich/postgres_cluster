#!/usr/bin/env python
"""
Prints out all the files with .log extension
"""
import os,re,subprocess
cores=[]
for root,dirs,files in os.walk("."):
    for name in files:
        path= root+"/"+name
        if name.endswith(".log") or name=="regression.diffs":
            print "*" * 76
            print "* %-72s *"%path
            print "*" * 76
            with open(path,"r") as f:
                print f.read()
        if name == "core" or re.match("core\\.[0-9]+",name) or re.match(".*\\.core",name):
            cores.append(path)
print ", ".join(cores)            
for f in cores:
    print "*" * 76
    print "* %-72s *"%f
    print "*" * 76
    gdb=subprocess.Popen(["gdb","src/backend/postgres",f],
        stderr=subprocess.PIPE,stdout=subprocess.PIPE,stdin=subprocess.PIPE)
    out,err=gdb.communicate("bt\nq\n")
    if err.index("core file may not match specified")>=0:
        m=re.search("Core was generated by `(.*)'",out)
        if m:
            gdb=subprocess.Popen(["gdb",m.group(1),f],
                                 stdout=subprocess.PIPE,stdin=subprocess.PIPE)
            out,err=gdb.communicate("bt\nq\n")
            
    
    print out

    
 

