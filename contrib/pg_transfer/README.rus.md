# pg_transfer

Модуль `pg_transfer` предоставляет возможность быстрого перемещения таблиц между инстансами PostgreSQL.

Расширение совместимо с PgPro9.6.? для *nix систем.

## Для чего нужен pg_transfer?

Для некоторых приложений узким местом является загрузка данных в базу, например, при переносе данных с региональных серверов в центральный. Стандартным методом является перенос схемы и данных при помощи утилит `pg_dump/pg_restore`. При этом большая часть нагрузки приходится на принимающий сервер. Загрузка данных осуществляется командами `INSERT` или `COPY`, что создаёт значительную загрузку дисковой подсистемы. Построение индексов и сбор статистики необходимо выполнить в новой базе уже после загрузки данных.

С помощью расширения `pg_transfer` можно подготовить таблицу (построить индексы и собрать статистику) отдельно от основных серверов и обеспечить фактически очень большую скорость добавления данных только для чтения. Модуль содержит дополнительные функции для использования утилитами `pg_dump/pg_restore`.


## Установка
Для установки расширения необходимо выполнить в psql команду.

```
CREATE EXTENSION pg_transfer;
```

## Основные опции

Флаги pg_dump:

* **`--transfer-dir $TRANSFER_DIR_PATH`** - директория, в которую будут перемещены файлы таблицы, заданных на ней индексов и TOAST. По умолчанию создаётся жесткая ссылка на файлы в директории указанной в опции --transfer-dir.
> **Будьте внимательны:** при удалении таблицы командой DROP такие ссылки станут невалидными.

* **`--copy-mode-transfer`** - В случае когда файлы СУБД и transfer-dir расположены на разных файловых системах нужно использовать опцию --copy-mode-transfer для получения копии файлов.

Флаги pg_restore:

* **`--transfer-dir $TRANSFER_DIR_PATH`** - директория, из которой будут перемещены файлы таблицы, заданных на ней индексов и TOAST. По умолчанию файлы перемещаются в базу командой rename().

* **`--copy-mode-transfer`** - Копировать файлы из директории `transfer-dir` вместо перемещения.

* **`--generate-wal`** - сгенерировать Xlog записи для всех файлов, для синхронизации с репликой. В случае, когда целевая СУБД реплицируется WAL-логами, флаг обязателен.


## Процесс переноса данных.

Перед переносом таблицы необходимо пометить её как доступную только на чтение.

```
ALTER TABLE tbl_name SET CONSTANT;
```

А также выполнить `VACUUM (ANALYZE)` для удаления устаревших записей и обновления статистики.

```
VACUUM (ANALYZE) tbl_name;
```

Перенос таблицы осуществляется в два этапа. На первом этапе дамп схемы снимается на вспомогательном сервере и восстанавливается на основном. Затем данные на вспомогательном сервере необходимо подготовить к переносу, используя информацию о восстановленной схеме, и перенести данные. Если исходная и целевая база расположены на одной файловой системе нужно как минимум один раз (при `pg_dump` или `pg_restore`) использовать --copy-mode-transfer опцию, чтобы получить копию данных. Если целевая СУБД реплицируется WAL-логами, то при подключении файлов pg_restore обязательно нужно
использовать опцию `--generate-wal`.


> **Важно:** архитектура обеих систем и настройки инстанса PostgreSQL должны обеспечивать идентичность бинарного формата данных. При восстановлении выполняется проверка вывода `pg_control_init()` - выравнивание, размер блока, размер сегмента и т.д..

### Этап 1.

```
pg_dump db -t tbl_name --schema-only -f $TRANSFER_DIR/archive.out
pg_restore -d newdb --schema-only $TRANSFER_DIR/archive.out
```

После восстановления схемы необходимо получить идентификатор TOAST таблицы.

```
psql newdb -c select reltoastrelid from pg_class where relname='tbl_name'
```

### Этап 2. В обеих базах должно быть установлено расширение `pg_transfer`.

Используя полученный в предыдущем шаге идентификатор TOAST таблицы, подготовить
таблицу к переносу и выполнить сброс данных на диск.

```
psql -d db -c select pg_transfer_freeze('tbl_name'::regclass::oid, reltoastrelid::oid);
psql -d db -c checkpoint;
```

Подготовка данных завершена. Теперь можно перенести данные в отдельную директорию, используя утилиту `pg_dump`.

```
pg_dump db -Fc -t tbl_name --copy-mode-transfer --transfer-dir $TRANSFER_DIR/ -f $TRANSFER_DIR/archive.out
```

И восстановить их на целевой базе данных.

```
pg_restore -d newdb --data-only --transfer-dir $TRANSFER_DIR/ $TRANSFER_DIR/archive.out
```